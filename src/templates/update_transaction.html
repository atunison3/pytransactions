{% extends 'base.html' %}

{% block title %}Update Transaction{% endblock %} 

{% block content %}
    <h1>Transaction Form</h1>
    <form id="transaction-form">
        <label for="transaction_id">Transaction ID:</label>
        <input type="number" id="transaction_id" name="transaction_id" required><br><br>
        
        <label for="amount">Amount:</label>
        <input type="text" id="amount" name="amount" required><br><br>
        
        <label for="date">Date:</label>
        <input type="date" id="date" name="date" required><br><br>
        
        <label for="description">Description:</label>
        <input type="text" id="description" name="description" required><br><br>
        
        <label for="category">Category:</label>
        <input type="text" id="category" name="category" required><br><br>
        
        <label for="subcategory">Subcategory:</label>
        <input type="text" id="subcategory" name="subcategory"><br><br>
        
        <label for="notes">Notes:</label>
        <textarea id="notes" name="notes"></textarea><br><br>

        <button type="button" id="update-button">Update Transaction</button>
    </form>
    <script>
        // Check if the token exists in localStorage
        const token = localStorage.getItem('access_token');
    
        if (!token) {
            alert('You are not authorized to view this page.');
            window.location.href = '/';
        }
    
        document.getElementById('logoutButton').addEventListener('click', function() {
            localStorage.removeItem('access_token');
            window.location.href = '/';
        });
    </script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const transactionIdInput = document.getElementById('transaction_id');
            const form = document.getElementById('transaction-form');
            const updateButton = document.getElementById('update-button');
    
            transactionIdInput.addEventListener('blur', async () => {
                const transactionId = transactionIdInput.value;
                if (transactionId) {
                    try {
                        const response = await fetch('/api/transactions/', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/x-www-form-urlencoded',
                            },
                            body: new URLSearchParams({
                                'transaction_id': transactionId,
                            }),
                        });
    
                        if (response.ok) {
                            const transaction = await response.json();
                            document.getElementById('amount').value = transaction.amount;
                            document.getElementById('date').value = transaction.date;
                            document.getElementById('description').value = transaction.description;
                            document.getElementById('category').value = transaction.category;
                            document.getElementById('subcategory').value = transaction.subcategory || '';
                            document.getElementById('notes').value = transaction.notes || '';
                        } else {
                            alert('Transaction not found');
                            form.reset();
                        }
                    } catch (error) {
                        console.error('Error fetching transaction:', error);
                    }
                }
            });
            // Update transaction on button click
            updateButton.addEventListener('click', async () => {
                const formData = new FormData(form);
                try {
                    const response = await fetch('/api/update-transaction/', {
                        method: 'POST',
                        body: formData,
                    });

                    if (response.ok) {
                        alert('Transaction updated successfully');
                        form.reset(); // Clear the form after successful submission
                    } else {
                        alert('Error updating transaction');
                    }

                } catch (error) {
                    console.error('Error updating transaction:', error);
                }
            });
        });
    </script>
{% endblock %}